{% extends 'base.html' %}
{% load static %}
{% load icons %}

{% block content %}
  {% if not puede_ver %}
    <div class="d-flex justify-content-center align-items-center" style="height: 60vh;">
      <div class="alert alert-danger d-flex align-items-center shadow-lg rounded-3 p-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-3 fs-3"></i>
        <div class="fw-semibold fs-5">No tiene permisos para acceder a este contenido</div>
      </div>
    </div>
  {% else %}
    <main class="container py-5">
      <section class="card card-body shadow-sm p-4">
        <div class="row">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center pb-4">
              <h1 class="display-5 fw-bold mb-2 mb-lg-0"><i class="bi bi-journal-text me-2 text-primary"></i>Gestión de fichas</h1>
              <div class="d-flex">
                {% if perfil.rol == 'instructor' %}
                  <a id="btnFichasMasivo" href="/fichas/crear_masivo" class="btn btn-primary d-flex align-items-center" data-toggle="tooltip" data-placement="top" title="Crear ficha masivo"><i class="bi bi-plus-lg me-2"></i> Nueva</a>
                {% elif perfil.rol == 'admin' %}
                  <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalImportarFichas" title="Importar fichas desde CSV"><i class="bi bi-upload me-1"></i> Importar</button>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalAsignarAprendices" title="Asignar aprendices a fichas"><i class="bi bi-people-fill me-1"></i> Asignar</button>
                  </div>
                {% endif %}
              </div>
            </div>
            <div id="contenedor-filtros" class="bg-light p-3 rounded-3 mb-4">
              <h5 class="mb-3"><i class="bi bi-funnel me-2 text-secondary"></i> Filtrar y organizar</h5>
              <form id="filtros-form" class="row g-3">
                <div class="col-md-3" id="contenedor-estado">
                  <div class="placeholder-glow">
                    <span class="placeholder col-12 rounded"></span>
                  </div>
                </div>
                <div class="col-md-3" id="contenedor-instructor">
                  <div class="placeholder-glow">
                    <span class="placeholder col-12 rounded"></span>
                  </div>
                </div>
                <div class="col-md-6" id="contenedor-programa">
                  <div class="placeholder-glow">
                    <span class="placeholder col-12 rounded"></span>
                  </div>
                </div>
              </form>
            </div>
            <div class="table-responsive">
              <table id="listado_fichas_table" class="table table-hover align-middle table-striped w-100"></table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal para editar ficha -->
    <div class="modal fade" id="editarFichaModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editarFichaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editarFichaModalLabel">Cambiar numero de ficha</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="formEditarFicha">
            {% csrf_token %}
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="num_ficha" class="form-label">Número de ficha:</label>
                  <input type="text" class="form-control" id="num_ficha" name="num" />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="fase" class="form-label">Fase actual</label>
                  <select name="fase_id" id="fase" class="form-select" required>
                    <option value="1">Análisis</option>
                    <option value="2">Planeación</option>
                    <option value="3">Ejecución</option>
                    <option value="4">Evaluación</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="departamento" class="form-label">Departamento</label>
                  <div id="contenedor-departamentos">
                    <div class="placeholder-glow">
                      <span class="placeholder col-12 rounded"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="municipio" class="form-label">Municipio</label>
                  <div id="contenedor-municipios">
                    <div class="placeholder-glow">
                      <span class="placeholder col-12 rounded"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="colegio" class="form-label">Colegio</label>
                  <div id="contenedor-instituciones">
                    <select name="insti_id" id="institucion" class="form-select" required disabled>
                      <option value="">Seleccione un colegio</option>
                    </select>
                    <small>De ser necesario seleccione nuevamente el departamento y municipio</small>
                  </div>
                </div>
                <!-- Centro de formación -->
                <div class="col-md-6 mb-3">
                  <label for="centro_forma" class="form-label">Centro de formación</label>
                  <div id="contenedor-centros">
                    <div class="placeholder-glow">
                      <span class="placeholder col-12 rounded"></span>
                    </div>
                  </div>
                </div>
              </div>
              <div id="errorEditarFicha" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
              <button type="submit" id="btnEditarFicha" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal: Importar fichas -->
    <div class="modal fade" id="modalImportarFichas" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalImportarFichasLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <form id="formImportarFichas" enctype="multipart/form-data">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalImportarFichasLabel">Importar fichas desde CSV</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="archivoFichas" class="form-label">Archivo CSV</label>
                <input class="form-control" type="file" id="archivoFichas" name="archivo" accept=".csv" required />
              </div>
              <div id="erroresFichas" class="alert alert-danger d-none"></div>
              <div id="resumenFichas" class="alert alert-success d-none"></div>
            </div>
            <div class="modal-footer">
              <button id="btnImportar" type="submit" class="btn btn-primary">Importar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal: Asignar aprendices -->
    <div class="modal fade" id="modalAsignarAprendices" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalAsignarAprendicesLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <form id="formAsignarAprendices" enctype="multipart/form-data">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalAsignarAprendicesLabel">Asignar aprendices a fichas desde CSV</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="archivoAprendices" class="form-label">Archivo CSV</label>
                <input class="form-control" type="file" id="archivoAprendices" name="archivo" accept=".csv" required />
              </div>
              <div id="erroresAprendices" class="alert alert-danger d-none"></div>
              <div id="resumenAprendices" class="alert alert-success d-none"></div>
            </div>
            <div class="modal-footer">
              <button id="btnAsignar" type="submit" class="btn btn-primary">Asignar</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script type="module" src="{% static 'js/formacion/listar_fichas.js' %}"></script>
{% endblock %}
